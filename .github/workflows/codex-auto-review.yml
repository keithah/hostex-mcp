name: Codex Auto Review

on:
  pull_request_target:
    types:
      - synchronize

jobs:
  trigger-codex-review:
    timeout-minutes: 20
    runs-on: ubicloud-standard-2
    permissions:
      issues: write
      pull-requests: write
    steps:
      - name: Trigger Codex review for new commits
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          REPO: ${{ github.repository }}
          HEAD_SHA: ${{ github.event.pull_request.head.sha }}
        shell: bash
        run: |
          set -euo pipefail

          comment_body="@codex review (auto-trigger for commit ${HEAD_SHA})"
          comment_id="$(gh api repos/${REPO}/issues/${PR_NUMBER}/comments -f body="${comment_body}" --jq '.id')"

          if [[ -n "${comment_id}" && "${comment_id}" != "null" ]]; then
            # Give Codex a moment to receive the comment event before auto-cleanup.
            sleep 5
            gh api repos/${REPO}/issues/comments/${comment_id} -X DELETE || true
          fi
